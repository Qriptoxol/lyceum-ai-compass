# Безопасность платформы Лицей №1

Этот документ описывает реализованные меры безопасности и рекомендации по безопасному использованию платформы.

## Реализованные меры безопасности

### 1. Аутентификация и авторизация

#### JWT защита
- Все Edge Functions защищены JWT токенами по умолчанию
- Публичные endpoints (webhook, verify-init-data) имеют собственную валидацию
- Telegram WebApp использует проверку подписи initData

#### Многоуровневая аутентификация
1. **Пользователи (через Telegram)**:
   - Проверка подписи Telegram WebApp initData
   - Автоматическое создание Supabase Auth пользователя
   - Генерация magic link сессии

2. **Администраторы**:
   - Отдельная таблица `admin_users` с хешированными паролями (bcrypt)
   - Rate limiting для защиты от brute-force атак
   - Отслеживание времени последнего входа

#### Row Level Security (RLS)
Все таблицы имеют настроенные RLS политики:

```sql
-- Профили пользователей
-- Пользователи видят только свой профиль
CREATE POLICY "Users can view own profile" ON profiles
  FOR SELECT USING (auth.uid() = id);

-- Администраторы видят все профили
CREATE POLICY "Admins can view all profiles" ON profiles
  FOR SELECT USING (has_role(auth.uid(), 'admin'));

-- Новости
-- Все видят опубликованные новости
CREATE POLICY "Everyone can view published news" ON news
  FOR SELECT USING (is_published = true);

-- Администраторы управляют всеми новостями
CREATE POLICY "Admins can manage news" ON news
  FOR ALL USING (has_role(auth.uid(), 'admin'));
```

### 2. Защита от атак

#### Rate Limiting
Реализовано для admin-login:
- **Максимум попыток**: 5 неудачных попыток входа
- **Окно времени**: 15 минут
- **Блокировка**: 30 минут после превышения лимита
- Хранение в памяти (для production рекомендуется Redis)

#### Валидация входных данных
Все Edge Functions проверяют:
- Длину входных данных
- Формат данных
- Обязательные поля
- SQL injection защита (используется Supabase client, не raw SQL)

#### Security Headers
Все Edge Functions возвращают защитные заголовки:
```javascript
{
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains'
}
```

#### CORS
Настроены правильные CORS заголовки:
- Поддержка preflight запросов
- Разрешенные заголовки определены явно

### 3. Безопасное хранение данных

#### Пароли
- Хешируются с помощью bcrypt (cost factor 10)
- Никогда не хранятся в открытом виде
- Передаются только через HTTPS

#### Секреты
Используются Supabase Secrets для:
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота
- `LOVABLE_API_KEY` - ключ для Lovable AI
- `ADMIN_SECRET_KEY` - секретный ключ для создания администраторов
- `SUPABASE_SERVICE_ROLE_KEY` - сервисный ключ Supabase

**Важно**: Секреты никогда не передаются на клиент!

#### Личные данные
- Telegram ID хранится как bigint
- RLS ограничивает доступ к личным данным
- Минимизация хранимых персональных данных

### 4. Безопасность Telegram бота

#### Проверка подписи
```typescript
async function verifyTelegramWebAppData(initData: string, botToken: string) {
  // HMAC-SHA256 проверка подписи
  // Защита от подделки данных
}
```

#### Webhook безопасность
- Проверка подписи каждого webhook запроса
- Отклонение невалидных запросов
- Логирование подозрительной активности

### 5. Безопасность API

#### Lovable AI
- Валидация длины запросов (макс. 1000 символов)
- Обработка rate limits (429, 402)
- Безопасные промпты без инъекций

#### Error Handling
- Общие сообщения об ошибках для пользователей
- Детальные логи только на сервере
- Не раскрывает внутреннюю структуру

## Рекомендации по безопасности

### Для администраторов

1. **Управление паролями**
   - Используйте сложные пароли (минимум 12 символов)
   - Используйте менеджер паролей
   - Регулярно меняйте пароли
   - Не используйте одинаковые пароли

2. **Секретные ключи**
   - Генерируйте криптографически стойкие ключи:
     ```bash
     openssl rand -hex 32
     ```
   - Никогда не коммитьте в Git
   - Храните в безопасном месте
   - Регулярно ротируйте

3. **Управление доступом**
   - Назначайте роли по принципу наименьших привилегий
   - Регулярно проверяйте список администраторов
   - Удаляйте неактивных пользователей

4. **Мониторинг**
   - Регулярно проверяйте логи Edge Functions
   - Отслеживайте подозрительную активность
   - Настройте алерты для критичных событий

### Для разработчиков

1. **Код**
   - Регулярно обновляйте зависимости
   - Используйте `npm audit` для проверки уязвимостей
   - Code review всех изменений
   - Тестируйте безопасность перед деплоем

2. **Secrets**
   - Используйте `.env.example` для документирования
   - Добавьте `.env*` в `.gitignore`
   - Используйте разные секреты для dev/prod

3. **Database**
   - Всегда используйте RLS
   - Тестируйте политики под разными ролями
   - Не используйте `SECURITY DEFINER` без необходимости
   - Используйте prepared statements (через Supabase client)

4. **Edge Functions**
   - Валидируйте все входные данные
   - Используйте TypeScript для type safety
   - Добавляйте rate limiting где нужно
   - Логируйте важные события

### Для пользователей

1. **Telegram**
   - Не передавайте свой Telegram аккаунт другим
   - Будьте осторожны с фишинговыми ботами
   - Проверяйте username бота перед использованием

2. **Данные**
   - Не делитесь конфиденциальной информацией в чате с ботом
   - Следите за подозрительными запросами данных

## Контрольный список безопасности

Перед деплоем в production:

- [ ] Все секреты установлены и уникальны
- [ ] RLS включен для всех таблиц
- [ ] RLS политики протестированы
- [ ] HTTPS включен (через Supabase/Lovable Cloud автоматически)
- [ ] Rate limiting настроен для критичных endpoints
- [ ] Логирование настроено
- [ ] Backup базы данных настроен
- [ ] Мониторинг настроен
- [ ] Документация обновлена
- [ ] Команда ознакомлена с мерами безопасности

## Реагирование на инциденты

### При обнаружении уязвимости:

1. **Немедленно**:
   - Оцените серьезность
   - Изолируйте затронутые компоненты
   - Уведомите команду

2. **В течение часа**:
   - Исправьте уязвимость
   - Разверните патч
   - Проверьте логи на признаки эксплуатации

3. **После устранения**:
   - Проведите post-mortem анализ
   - Обновите документацию
   - Обучите команду

### При компрометации учетных данных:

1. Немедленно сбросьте скомпрометированные ключи:
   ```bash
   # Для Telegram бота
   # 1. Создайте новый токен через @BotFather
   # 2. Обновите TELEGRAM_BOT_TOKEN в Supabase Secrets
   
   # Для администраторов
   # Используйте Edge Function для изменения пароля
   ```

2. Проверьте логи на несанкционированный доступ

3. Уведомите затронутых пользователей если необходимо

## Аудит безопасности

### Регулярные проверки (ежемесячно):
- [ ] Проверка активных администраторов
- [ ] Проверка логов на аномалии
- [ ] Обновление зависимостей
- [ ] Проверка RLS политик

### Глубокий аудит (ежеквартально):
- [ ] Penetration testing
- [ ] Code security review
- [ ] Infrastructure audit
- [ ] Compliance check

## Compliance и стандарты

Платформа следует следующим практикам:
- **OWASP Top 10** - защита от основных веб-уязвимостей
- **GDPR** - минимизация и защита персональных данных
- **ISO 27001** - информационная безопасность (базовые принципы)

## Контакты

При обнаружении уязвимости свяжитесь с командой безопасности:
- Email: security@lyceum1.local (замените на реальный)
- Telegram: @lyceum1_security (замените на реальный)

**Responsible Disclosure**: Мы ценим ответственное раскрытие информации о уязвимостях.

## Дополнительные ресурсы

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Supabase Security](https://supabase.com/docs/guides/auth/managing-user-data)
- [Telegram Bot Security](https://core.telegram.org/bots/features#security)
- [PostgreSQL Security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)

---

**Последнее обновление**: 2024-11-24
**Версия документа**: 1.0
